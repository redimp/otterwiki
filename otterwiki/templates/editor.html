{# vim: set et ts=8 sts=4 sw=4 ai: #}
{% extends "preview.html" %}
{#
    Head
#}
{% block head %}
<style type="text/css" media="screen">
</style>
<link href="{{ url_for("static", filename="css/codemirror.css") | debug_unixtime }}" rel="stylesheet" />
<script>
 function hideMarkdown() {
     let h = document.getElementById("markdown-helper");
     currDisplay = h.style.display;
     h.style.display = currDisplay === "none" ? "block" : "none";
 }
</script>
{% endblock %}
{#
    Navbar
#}
{% block navbar %}
<a href="{{ url_for('view', path=pagepath) }}" class="btn btn-danger mr-5" role="button"><i class="fas fa-window-close"></i></a>
<button class="btn btn-success mr-5" onclick="otterwiki.toggleModal('modal-commit')"><i class="fas fa-save"></i></button>
<button type="submit" class="btn btn-primary" form="pagecontent"><i class="far fa-eye"></i></button>
{% endblock %}
{#
    Sidebar Menu
#}
{% block menu %}
{{ super() }}
                <a href="{{ url_for("syntax") }}" class="sidebar-link sidebar-link-with-icon" target="_blank">
                    <span class="sidebar-icon">
                        <i class="fab fa-markdown"></i>
                    </span>
                    Markdown Syntax
                </a>
{% endblock %}
{#
    Content
#}
{% block content_wrapper %}
        <!-- Content wrapper start -->
<div class="content-wrapper">
      <div class="position-absolute bottom-0 z-50">
        <div onclick="hideMarkdown()" class="card p-10 m-0 w-200 border rounded-0 rounded-top">
            <span class="pr-5">
                <i class="fab fa-markdown"></i>
                </span>
                Markdown Syntax
        </div>
{#        <hr style="margin:0px">#}
        <div id="markdown-helper" class="card border rounded-0" style="overflow-y: scroll; max-height: 40vh; margin: 0; display: none">
            <a href="/-/syntax"><span class="pl-5"><i class="fab fa-arrow"></i></span>Full Syntax Guide</a>
            {% include "_syntax.html" %}
        </div>
    </div>
    <div class="container-fluid z-10">
        <div class="row" style="height:calc(100vh - 92px); overflow-y: scroll">
            <div class="col-xl-9" style="height:100%; overflow-y: scroll">
                <form id="pagecontent" action="{{ url_for('preview', path=pagepath) }}" method="post">
                <input id="pc_cursor_line" type="hidden" name="cursor_line" value="" />
                <input id="pc_cursor_ch" type="hidden" name="cursor_ch" value="" />
                <textarea id="content_editor" name="content_editor">{{ content_editor }}</textarea>
                </form>
            </div>
            <div class="col-xl-3 pt-15" >
                <div class="position-fixed" style="height:100vh; overflow-y: scroll">
                    <div class="pl-20 pb-15">
                        {% if has_permission('WRITE') %}
                        <a href="{{ url_for("attachments", pagepath=pagepath) }}" class="btn btn-primary" role="button"><i class="fas fa-pencil-alt pr-5"></i> Edit Attachments</a>
                        {% else %}
                        <a href="{{ url_for('login') }}" class="btn" role="button"><i class="fas fa-sign-in-alt" title="Login"></i> Login to Edit Page</a>
                        {% endif %}
                    </div>

    {#              #Todo: This Attachments view could maybe be refactored out into it's own tempalte#}
                    <h5 class="sidebar-title">Attachments</h5>
                    <div class="sidebar-divider" ></div>
                    {% for f in files %}
    {#                            <a href="{{f.url}}">{% if f.thumbnail_url %}<img src="{{f.thumbnail_url}}"/>{%else%}{{f.thumbnail_icon|safe}}{%endif%}</a>#}
                        <div class="dropdown dropdown pl-20">
                            <a href="#" data-toggle="dropdown" id="dropdown-toggle-btn-{{loop.index}}" aria-haspopup="true" aria-expanded="false">
                                <i class="fas fa-copy"></i>
                                <div style="z-index: 1000" class="dropdown-menu" aria-labelledby="dropdown-toggle-btn-{{loop.index}}">
                                    <h6 class="dropdown-header">Markdown Shortcuts <span class="font-size-12">- Click to copy to clipboard</span></h6>
                                    {% if f.thumbnail_url %}
                                        <a href="#" onclick="navigator.clipboard.writeText('![]({{f.url}})')" class="dropdown-item"><i class="fas fa-copy"></i> Inline Image:</a>
                                        <div class="dropdown-item font-size-12">![]({{f.url}})</div>
                                        <div class="dropdown-divider"></div>
                                        <a href="#" onclick="navigator.clipboard.writeText('[![]({{f.thumbnail_url}})]({{f.url}})')" class="dropdown-item">Link with Thumbnail:</a>
                                        <div class="dropdown-item font-size-12>">[![]({{f.thumbnail_url}})]({{f.url}})</div>
                                        <div class="dropdown-divider"></div>
                                    {% endif %}
                                    <a href="#" onclick="navigator.clipboard.writeText('[{{f.filename}}]({{f.url}})')" class="dropdown-item"><i class="fas fa-copy"></i> Link Attachment:</a>
                                    <div class="dropdown-item font-size-12">[{{f.filename}}]({{f.url}})</div>
                                </div>
                            </a>
                        </div>
                        <a class="sidebar-link pl-5" style="display: inline" href="{{ url_for("edit_attachment", pagepath=pagepath, filename=f.filename) }}">{{f.filename}}</a><br/>
                        {% endfor %}
                        <p class="p-15 text-muted">Additional media can be added to this wiki by clicking the 'Add Attachment...' button, or, you can drag and drop a file into the web editor and it will be uploaded and embedded when the page is saved.</p>
                    </div>
               </div>
        </div>
    </div>
</div>
        <!-- Content wrapper end -->
{% endblock %}
{#
    Javascript
#}
{% block js %}
{# load the codemirror stuff #}
<script src="{{ url_for("static", filename="js/otterwiki.js") | debug_unixtime }}" type="text/javascript" charset="utf-8"></script>
<script src="{{ url_for("static", filename="js/codemirror.js") }}" type="text/javascript" charset="utf-8"></script>
<script src="{{ url_for("static", filename="js/cm-markdown.js") }}" type="text/javascript" charset="utf-8"></script>
<script src="{{ url_for("static", filename="js/cm-continuelist.js") }}" type="text/javascript" charset="utf-8"></script>
<script src="{{ url_for("static", filename="js/inline-attachment.js") }}" type="text/javascript" charset="utf-8"></script>
<script src="{{ url_for("static", filename="js/codemirror-4.inline-attachment.js") }}" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript">
    var cm_editor = CodeMirror.fromTextArea(document.getElementById("content_editor"), {
        mode: 'markdown',
        lineNumbers: true,
        theme: "otterwiki",
        lineWrapping: true,
        indentWithTabs: false,
        autofocus: true,
        extraKeys: {"Enter": "newlineAndIndentContinueMarkdownList"},
      });
{% if cursor_line and cursor_ch %}
    cm_editor.setCursor({ line: {{cursor_line}}, ch: {{cursor_ch}} } );
{% endif %}
{#
thx to https://github.com/sparksuite/simplemde-markdown-editor/issues/328#issuecomment-227075500
#}
    inlineAttachment.editors.codemirror4.attach(cm_editor, {
        uploadUrl: '{{ url_for('inline_attachment', pagepath=pagepath) }}',
        urlText: "![]({filename})",
        onFileUploadResponse: function(xhr) {
            var result = JSON.parse(xhr.responseText),
            filename = result[this.settings.jsonFieldName];

            if (result && filename) {
                var newValue;
                if (typeof this.settings.urlText === 'function') {
                    newValue = this.settings.urlText.call(this, filename, result);
                } else {
                    newValue = this.settings.urlText.replace(this.filenameTag, filename);
                }
                var text = this.editor.getValue().replace(this.lastValue, newValue);
                this.editor.setValue(text);
                this.settings.onFileUploaded.call(this, filename);
            }
            return false;
        }
    });
    document.getElementById('pagecontent').onsubmit = function() {
        var cm_cursor = cm_editor.getCursor();
        document.getElementById('pc_cursor_line').value = cm_cursor.line;
        document.getElementById('pc_cursor_ch').value = cm_cursor.ch;

    }
    document.getElementById('saveform').onsubmit = function() {
        var content_editor = cm_editor.getValue();
        document.getElementById('content_update').value = content_editor;
    };
</script>
{% endblock %}