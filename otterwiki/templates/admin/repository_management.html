{# vim: set et ts=8 sts=4 sw=4 ai ft=jinja.html: #}
{% extends "settings.html" %}
{% block content %}
{##}
<div class="card m-auto m-lg-20">
<div class="mw-full">
    <form action="{{ url_for("admin_repository_management") }}" method="POST">
<h2 class="card-title">Repository Management</h2>
{##}
    <div class="form-group">
      <div class="custom-checkbox">
        <input {%if config.GIT_WEB_SERVER %}checked=checked{% endif %} type="checkbox" id="git_web_server" name="git_web_server" value="True">
        <label for="git_web_server">Enable Git Web server <span class="text-secondary-dm bg-secondary-lm">(Experimental Feature)</span>.</label>
        <div class="mt-5">
            Enable this to allow users with the permission to READ to clone and pull the wiki content via git and users with UPLOAD/Attachment management permissions to push content. When enabled the URL <code>{{url_for("dotgit", _external=True)}}</code> will be displayed in the users settings.
        </div>
      </div>
    </div>
{##}
    <div class="form-group">
      <div class="custom-checkbox">
        <input {%if config.GIT_REMOTE_PUSH_ENABLED %}checked=checked{% endif %} type="checkbox" id="git_remote_push_enabled" name="git_remote_push_enabled" value="True">
        <label for="git_remote_push_enabled">Enable pushing to SSH remote <span class="text-secondary-dm bg-secondary-lm">(Experimental Feature)</span>.</label>
        <div class="mt-5">
            Enable this to automatically push all changes to a remote git repository via SSH on every wiki content change.
        </div>
      </div>

      {# push configuration parameters #}
      <div class="ml-20" id="git_remote_push_params" style="display: none;">
          <div class="form-group mt-10">
              <label for="git_remote_push_url" class="required">SSH Remote URL</label>
              <input name="git_remote_push_url" type="text" placeholder="git@github.com:username/repo.git" class="form-control" id="git_remote_push_url" value="{{ config.GIT_REMOTE_PUSH_URL or "" }}">
              <div class="form-text">
                  The SSH remote URL to push to. Supported formats:
                  <ul>
                      <li><code>ssh://[user@]host.xz[:port]/path/to/repo.git</code></li>
                      <li><code>git://host.xz[:port]/path/to/repo.git</code></li>
                      <li><code>git@github.com:username/repo.git</code> (for GitHub)</li>
                  </ul>
              </div>
          </div>

          <div class="form-group">
              <label for="git_remote_push_private_key">SSH Private Key (Optional)</label>
              <textarea name="git_remote_push_private_key" class="form-control" id="git_remote_push_private_key" rows="10" placeholder="-----BEGIN OPENSSH PRIVATE KEY-----
...
-----END OPENSSH PRIVATE KEY-----">{% if config.GIT_REMOTE_PUSH_PRIVATE_KEY %}**********{% endif %}</textarea>
              <div class="form-text">
                  Optional SSH private key for authentication. Leave empty if the server doesn't require authentication or it's being handled externally.
                  The key will be stored internally and never displayed after saving.
                  However, for security purposes <strong>it's highly recommended to create a key specifically to access the defined remote</strong> and nothing else.
              </div>
          </div>
      </div>
    </div>
{##}
    <div class="form-group">
      <div class="custom-checkbox">
        <input {%if config.GIT_REMOTE_PULL_ENABLED %}checked=checked{% endif %} type="checkbox" id="git_remote_pull_enabled" name="git_remote_pull_enabled" value="True">
        <label for="git_remote_pull_enabled">Enable pulling from SSH remote <span class="text-secondary-dm bg-secondary-lm">(Experimental Feature)</span>.</label>
        <div class="mt-5">
            Enable this to automatically pull changes from a remote git repository via SSH by triggering a webhook URL.
        </div>
      </div>

      {# pull configuration parameters #}
      <div class="ml-20" id="git_remote_pull_params" style="display: none;">
          <div class="form-group mt-10">
              <label for="git_remote_pull_url" class="required">SSH Remote URL</label>
              <input name="git_remote_pull_url" type="text" placeholder="git@github.com:username/repo.git" class="form-control" id="git_remote_pull_url" value="{{ config.GIT_REMOTE_PULL_URL or "" }}">
              <div class="form-text">
                  The SSH remote URL to pull from. Supported formats:
                  <ul>
                      <li><code>ssh://[user@]host.xz[:port]/path/to/repo.git</code></li>
                      <li><code>git://host.xz[:port]/path/to/repo.git</code></li>
                      <li><code>git@github.com:username/repo.git</code> (for GitHub)</li>
                  </ul>
              </div>
          </div>

          <div class="form-group">
              <label for="git_remote_pull_private_key">SSH Private Key (Optional)</label>
              <textarea name="git_remote_pull_private_key" class="form-control" id="git_remote_pull_private_key" rows="10" placeholder="-----BEGIN OPENSSH PRIVATE KEY-----
...
-----END OPENSSH PRIVATE KEY-----">{% if config.GIT_REMOTE_PULL_PRIVATE_KEY %}**********{% endif %}</textarea>
              <div class="form-text">
                  Optional SSH private key for authentication. Leave empty if the server doesn't require authentication or it's being handled externally.
                  The key will be stored internally and never displayed after saving.
                  However, for security purposes <strong>it's highly recommended to create a key specifically to access the defined remote</strong> and nothing else.
              </div>
          </div>

          <div class="form-group">
              <label for="git_remote_pull_webhook_url">Pull webhook URL</label>
              <div class="input-group">
                  <input type="text" class="form-control" id="git_remote_pull_webhook_url" readonly>
                  <div class="input-group-append">
                      <button class="btn btn-outline-secondary" type="button" id="copy_webhook_url" title="Copy webhook URL">
                          <i class="fas fa-copy"></i>
                      </button>
                  </div>
              </div>
              <div class="form-text">
                  Use this URL to trigger pulls from external services (e.g., GitHub webhooks).
              </div>
          </div>
      </div>
    </div>
{##}
  <div class="mt-10 d-flex justify-content-between align-items-center">
    <div>
      <input class="btn btn-primary" name="update_preferences" type="submit" value="Save Preferences">
    </div>

    {# action buttons #}
    {% if config.GIT_REMOTE_PUSH_ENABLED or config.GIT_REMOTE_PULL_ENABLED %}
    <div>
      {% if config.GIT_REMOTE_PUSH_ENABLED %}
      <input class="btn mr-5" name="git_push" type="submit" value="Push">
      <input class="btn mr-5" name="git_force_push" type="submit" value="Force Push" onclick="return confirm('Are you sure you want to do a force push? This will overwrite the remote tree and this action is usually irreversible.')">
      {% endif %}
      {% if config.GIT_REMOTE_PULL_ENABLED %}
      <input class="btn" name="git_pull" type="submit" value="Pull">
      {% endif %}
    </div>
    {% endif %}
  </div>
</form>

{# action results #}
{% if git_action_result %}
<div class="mt-20" id="git_action_results">
  <div class="card">
    <div class="card-body">
      <h5 class="card-title">{{ git_action_result.action|title }} Results</h5>
      <pre class="{% if git_action_result.success %}bg-success{% else %}bg-danger{% endif %} text-light p-10" style="white-space: pre-wrap; font-family: monospace;">{{ git_action_result.output }}</pre>
    </div>
  </div>
</div>
{% endif %}
</div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const pushCheckbox = document.getElementById('git_remote_push_enabled');
    const pushParams = document.getElementById('git_remote_push_params');

    function togglePushFields() {
        if (pushCheckbox.checked) {
            pushParams.style.display = 'block';
        } else {
            pushParams.style.display = 'none';
        }
    }

    togglePushFields();
    pushCheckbox.addEventListener('change', togglePushFields);

    const pullCheckbox = document.getElementById('git_remote_pull_enabled');
    const pullParams = document.getElementById('git_remote_pull_params');
    const pullUrlInput = document.getElementById('git_remote_pull_url');
    const webhookUrlInput = document.getElementById('git_remote_pull_webhook_url');
    const copyButton = document.getElementById('copy_webhook_url');

    async function generateWebhookHash(url) {
        if (!url) return '';
        // generate SHA-256 hash to match backend expectation
        const str = url + 'otterwiki';
        const encoder = new TextEncoder();
        const data = encoder.encode(str);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        return hashHex;
    }

    async function updateWebhookUrl() {
        const remoteUrl = pullUrlInput.value.trim();
        if (remoteUrl) {
            const hash = await generateWebhookHash(remoteUrl);
            const webhookUrl = window.location.origin + '/-/api/v1/pull/' + hash;
            webhookUrlInput.value = webhookUrl;
        } else {
            webhookUrlInput.value = '';
        }
    }

    function togglePullFields() {
        if (pullCheckbox.checked) {
            pullParams.style.display = 'block';
            updateWebhookUrl();
        } else {
            pullParams.style.display = 'none';
        }
    }

    togglePullFields();
    pullCheckbox.addEventListener('change', togglePullFields);
    pullUrlInput.addEventListener('input', updateWebhookUrl);

    copyButton.addEventListener('click', function() {
        webhookUrlInput.select();
        webhookUrlInput.setSelectionRange(0, 99999); // For mobile devices
        navigator.clipboard.writeText(webhookUrlInput.value).then(function() {
            const originalText = copyButton.innerHTML;
            copyButton.innerHTML = '<i class="fas fa-check"></i>';
            setTimeout(function() {
                copyButton.innerHTML = originalText;
            }, 2000);
        }).catch(function() {
            // fallback for older browsers
            document.execCommand('copy');
            const originalText = copyButton.innerHTML;
            copyButton.innerHTML = '<i class="fas fa-check"></i>';
            setTimeout(function() {
                copyButton.innerHTML = originalText;
            }, 2000);
        });
    });

    {% if git_action_result %}
    // scroll to results area after a short delay
    setTimeout(function() {
        const resultsElement = document.getElementById('git_action_results');
        if (resultsElement) {
            resultsElement.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }
    }, 100);
    {% endif %}
});
</script>
{% endblock %}
